<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Private Documents</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:32px}
    h1{margin:0 0 16px}
    #wrap{max-width:720px}
    .btn{padding:10px 14px;border:1px solid #222;border-radius:10px;background:#fff;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    #status{margin-top:16px;color:#444;white-space:pre-wrap}
  </style>
</head>
<body>
  <div id="wrap">
    <h1>Private Documents</h1>
    <p>Access is restricted to BACON NFT holders. Signing is free (no gas).</p>

    <button id="connect" class="btn">Connect Wallet</button>
    <div id="status" role="status"></div>
  </div>

  <script>
    const endpoint = "/api/view"; // через netlify.toml редиректит на /.netlify/functions/view
    const statusBox = document.getElementById("status");
    const btn = document.getElementById("connect");

    function setStatus(msg){ statusBox.textContent = msg || ""; }

    btn.addEventListener("click", async () => {
      setStatus("");
      if (!window.ethereum){
        setStatus("No wallet found. Please install MetaMask or a compatible wallet.");
        return;
      }
      try{
        btn.disabled = true;
        const [account] = await window.ethereum.request({ method: "eth_requestAccounts" });
        setStatus("Checking NFT ownership…");

        const res = await fetch(endpoint, {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify({ address: account })
        });

        const data = await res.json().catch(()=> ({}));

        if (data && data.ok && data.url){
          // открываем документ
          window.location.href = data.url;
        } else {
          setStatus(data?.error || "Access denied.");
        }
      } catch (e){
        setStatus(e?.message || String(e));
      } finally {
        btn.disabled = false;
      }
    });
  </script>
</body>
</html>
