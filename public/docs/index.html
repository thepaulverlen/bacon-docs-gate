<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BACON — Private Docs</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;padding:24px;color:#111}
    h1{margin:0 0 16px}
    p{margin:0 0 16px}
    .btn{
      display:inline-block;padding:10px 14px;border:1px solid #ddd;border-radius:10px;background:#fff;
      cursor:pointer;user-select:none;transition:box-shadow .15s ease
    }
    .btn:focus{outline:0;box-shadow:0 0 0 3px rgba(66,153,225,.5)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    #status{margin-top:12px;color:#444;min-height:1.2em}
    #pdf{display:none;width:100%;height:85vh;border:0;margin-top:16px}
  </style>
</head>
<body>
  <h1>Private Documents</h1>
  <p>Доступ только для держателей NFT <b>BACON</b>. Подпись бесплатна, газа нет.</p>

  <button id="connectBtn" type="button" class="btn">Connect Wallet</button>
  <div id="status"></div>

  <!-- сюда покажем документ -->
  <iframe id="pdf"></iframe>

  <script>
    (function () {
      const btn = document.getElementById('connectBtn');
      const statusEl = document.getElementById('status');
      const pdfFrame = document.getElementById('pdf');

      function setStatus(msg){ statusEl.textContent = msg || ''; }

      // Гарантированно навешиваем обработчик после инициализации DOM
      document.addEventListener('DOMContentLoaded', () => {
        btn.addEventListener('click', onConnectClick, { passive: true });
      });

      async function onConnectClick () {
        try {
          if (!window.ethereum) {
            setStatus('Не найден провайдер Ethereum. Установите/включите MetaMask/OKX/Trust Wallet.');
            alert('Не найден провайдер Ethereum. Установите MetaMask.');
            return;
          }

          btn.disabled = true;
          setStatus('Подключаем кошелёк…');

          // Запрос аккаунта
          const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
          const account = (accounts && accounts[0] || '').toLowerCase();

          setStatus('Проверяем доступ…');

          // Вызов Netlify Function (маршрут настроен в netlify.toml → /api/view)
          const res = await fetch('/api/view?address=' + encodeURIComponent(account), { method: 'GET' });

          // Если функция отдаёт PDF — показываем его
          const ct = res.headers.get('content-type') || '';
          if (res.ok && ct.includes('application/pdf')) {
            const blob = await res.blob();
            const url = URL.createObjectURL(blob);
            pdfFrame.src = url;
            pdfFrame.style.display = 'block';
            setStatus('Доступ подтверждён ✔');
          } else {
            // Иначе читаем текст ошибки/причину
            const txt = await res.text().catch(() => '');
            setStatus('Доступ запрещён: ' + (txt || res.status + ' ' + res.statusText));
            btn.disabled = false;
          }
        } catch (err) {
          console.error(err);
          setStatus('Ошибка: ' + (err?.message || err));
          btn.disabled = false;
        }
      }
    })();
  </script>
</body>
</html>
