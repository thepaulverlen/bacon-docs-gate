<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Private Documents</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:32px}
    h1{font-size:34px;margin:0 0 16px}
    p{margin:0 0 16px}
    #msg{margin-left:12px;color:#d22}
    .btn{display:inline-block;padding:10px 14px;border-radius:8px;border:0;background:#2563eb;color:#fff;font-weight:600;cursor:pointer}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
  </style>
</head>
<body>
  <h1>Private Documents</h1>
  <p>Access is restricted to <b>BACON NFT</b> holders. Signing is free (no gas).</p>

  <button id="connect" class="btn">Connect Wallet</button>
  <span id="msg"></span>

  <script type="module">
    const BTN  = document.getElementById('connect');
    const MSG  = document.getElementById('msg');

    // Адрес serverless-функции — фиксированный путь на Netlify
    const FN_URL = '/.netlify/functions/view';

    function show(text, isError=true){
      MSG.textContent = text || '';
      MSG.style.color = isError ? '#d22' : '#0a0';
    }

    function wait(on=true){
      BTN.disabled = on;
      BTN.textContent = on ? 'Waiting for wallet…' : 'Connect Wallet';
    }

    async function connect() {
      try {
        if (!window.ethereum) {
          show('No wallet found. Please install MetaMask or a compatible wallet.');
          return;
        }

        wait(true); show('');

        // 1) Запрашиваем аккаунт
        const [address] = await window.ethereum.request({ method: 'eth_requestAccounts' });

        // (опционально) Проверяем сеть — mainnet (0x1)
        const chainId = await window.ethereum.request({ method: 'eth_chainId' });
        if (chainId !== '0x1') {
          show('Wrong network. Please switch your wallet to Ethereum Mainnet.');
          wait(false);
          return;
        }

        // (опционально) Подпись без газа — просто антибот
        const message = `Sign to verify holder access for BACON docs. Nonce: ${Date.now()}`;
        await window.ethereum.request({
          method: 'personal_sign',
          params: [message, address]
        });

        // 2) Обращаемся к функции-гейту
        //    ВАЖНО: URL должен быть строкой — здесь он жёстко задан в FN_URL.
        const res = await fetch(FN_URL, {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify({ address })
        });

        if (!res.ok) {
          // Попробуем прочитать текст ошибки
          let err = '';
          try { const j = await res.json(); err = j?.error || ''; } catch {}
          show(err || `Access denied (${res.status})`);
          wait(false);
          return;
        }

        const data = await res.json();
        if (!data?.url) {
          show('Unexpected server response: no URL.');
          wait(false);
          return;
        }

        // 3) Пускаем внутрь
        show('Access granted. Opening…', false);
        window.location.href = data.url;

      } catch (e) {
        console.error(e);
        show(e?.message || 'Something went wrong.');
        wait(false);
      }
    }

    BTN.addEventListener('click', connect);
  </script>
</body>
</html>
